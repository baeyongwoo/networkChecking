<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë©€í‹° í¬íŠ¸ ì§„ë‹¨ê¸°</title>
    <style>
        body {
            background-color: #1e1e1e;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            padding: 2em;
            position: relative;
        }

        h1 {
            color: #00ff99;
            text-align: center;
            margin-bottom: 2em;
        }

        form {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1em;
            margin-bottom: 2em;
        }

        input, button {
            padding: 0.6em 1em;
            font-size: 1em;
            background-color: #2e2e2e;
            color: #dcdcdc;
            border: 1px solid #555;
            border-radius: 6px;
        }

        button:hover {
            background-color: #00ff99;
            color: #000;
            transform: scale(1.05);
        }

        #loadingMessage {
            display: none;
            text-align: center;
            margin-top: 1em;
            font-size: 1.2em;
            color: #00ff99;
        }

        .centered {
            max-width: 900px;
            margin: 0 auto;
            margin-bottom: 3em;
        }

        .card {
            background-color: #111;
            padding: 1.5em;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,255,153,0.2);
            border: 1px solid #444;
            white-space: pre-wrap;
            font-size: 16px;
        }

        .modal-button {
            margin-top: 1em;
            background-color: #222;
            color: #00ff99;
            border: 1px solid #00ff99;
            border-radius: 6px;
            padding: 0.6em 1.2em;
            cursor: pointer;
        }

        .modal-button:hover {
            background-color: #00ff99;
            color: #000;
        }

        .console-modal {
            display: none;
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 900px;
            background: rgba(0, 0, 0, 0.95);
            color: #0f0;
            padding: 1.5em;
            border-radius: 10px;
            border: 2px solid #00ff99;
            z-index: 1000;
        }

        .console-modal button {
            background: #222;
            color: #fff;
            border: none;
            padding: 0.5em 1em;
            float: right;
            border-radius: 4px;
            cursor: pointer;
        }

        .console-modal button:hover {
            background-color: #00ff99;
            color: #000;
        }

        .console-modal h3 {
            margin-top: 0;
            color: #00ff99;
        }

        .console-modal pre {
            max-height: 400px;
            overflow-y: auto;
        }

        .hint {
            margin-top: 1em;
            font-size: 0.95em;
        }

        .hint.warning {
            color: #ff4444;
            font-weight: bold;
        }

        .hint.guide {
            color: #ff6666;
        }

        .top-right-buttons {
            position: fixed;         /* â† ê³ ì • ìœ„ì¹˜ë¡œ ë³€ê²½ */
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 9999;           /* ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— í‘œì‹œ */
        }

        .top-right-buttons button {
            background-color: #333;
            color: #fff;
            border: 1px solid #888;
            padding: 0.5em 1em;
            border-radius: 6px;
            cursor: pointer;
        }

        .top-right-buttons button:hover {
            background-color: #00ff99;
            color: #000;
            border-color: #00ff99;
        }
    </style>
</head>
<body>

<!-- ìš°ì¸¡ ìƒë‹¨ ì„¤ì • ë²„íŠ¼ -->
<div class="top-right-buttons">
    <button onclick="callNetworkSettings()">ğŸ’» ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì—´ê¸°</button>
    <button onclick="callPortSettings()">ğŸ” ë°©í™”ë²½ ì„¤ì • ì—´ê¸°</button>
</div>

<h1>ğŸ§  ë©€í‹° í¬íŠ¸ ì§„ë‹¨ê¸°</h1>

<form id="diagnoseForm" method="post">
    <input type="text" name="target" placeholder="IP ë˜ëŠ” ë„ë©”ì¸ ì…ë ¥" th:value="${target}" required />
    <button type="button" onclick="submitTo('/diagnose-multi')">ğŸ” ì£¼ìš” í¬íŠ¸ </button>
    <button type="button" onclick="submitTo('/scan-all')">ğŸ§¨ ì „ì²´ í¬íŠ¸ ìŠ¤ìº” (1~50000)</button>

</form>

<div id="loadingMessage">
    <span id="typingText"></span>
</div>
<!-- ì „ì²´ í¬íŠ¸ ìŠ¤ìº” ê²°ê³¼ ì¶œë ¥ -->
<div th:if="${result != null}" class="centered">
    <h2 style="color:#00ff99;">ğŸ§¨ ì „ì²´ í¬íŠ¸ ìŠ¤ìº” ê²°ê³¼</h2>

    <div class="card">
        <pre th:text="${result}"></pre> <!-- ë˜ëŠ” ${result.fullOutput} -->
    </div>

<!--    <div th:if="${scannedPorts != null}">-->
<!--        <h3 style="margin-top:1em;">âœ… ì—´ë¦° í¬íŠ¸ ëª©ë¡:</h3>-->
<!--        <ul>-->
<!--            <li th:each="p : ${scannedPorts}" th:text="'í¬íŠ¸ ' + ${p}"></li>-->
<!--        </ul>-->
<!--    </div>-->
</div>

<!-- í¬íŠ¸ë³„ ë¶„ì„ ê²°ê³¼ ì¹´ë“œ -->
<div th:each="res : ${multiResults}" class="centered">
    <h2 style="color:#00ff99;">
        ğŸ“Š í¬íŠ¸ [[${res.port}]] ([[${res.serviceName}]])
        <span th:if="${res.portOpen}">âœ… ì—´ë¦¼</span>
        <span th:if="${!res.portOpen}">âŒ ë‹«í˜</span>
    </h2>

    <div class="card">
        <pre th:text="${res.analysisSummary}"></pre>
    </div>

    <div th:if="${res.riskHint != null}" class="hint warning">
        [[${res.riskHint}]]
    </div>

<!--    <div th:if="${res.resolutionHint != null}" class="hint guide">-->
<!--        âš ï¸ í•´ê²° ê°€ì´ë“œ: [[${res.resolutionHint}]]-->
<!--    </div>-->

    <!-- ì—°ê²° ì‹¤íŒ¨ ì‹œ ì„¤ì • ë²„íŠ¼ -->
<!--    <div th:if="${!res.portOpen or !res.httpSuccess or !res.pingSuccess}" style="margin-top:1em;">-->
<!--        <button onclick="openNetworkSettings()" style="margin-right:10px;">ğŸ’» ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì—´ê¸°</button>-->
<!--        <button onclick="openFirewallSettings()">ğŸ” ë°©í™”ë²½ ì„¤ì • ì—´ê¸°</button>-->
<!--    </div>-->

    <button class="modal-button" th:attr="data-port=${res.port}" onclick="showConsole(this)">ğŸ“œ ì½˜ì†” ë¡œê·¸ ë³´ê¸°</button>
</div>

<!-- í¬íŠ¸ë³„ ì½˜ì†” ë¡œê·¸ ëª¨ë‹¬ -->
<div th:each="res : ${multiResults}">
    <div th:attr="id='consoleModal-' + ${res.port}" class="console-modal">
        <button th:attr="onclick='hideConsole(' + ${res.port} + ')'">ë‹«ê¸°</button>
        <h3>ğŸ“œ í¬íŠ¸ [[${res.port}]] ì½˜ì†” ë¡œê·¸</h3>
        <pre th:text="${res.fullOutput}"></pre>
    </div>
</div>

<script>
    function typeLoadingMessage(text, elementId, speed = 80) {
        const el = document.getElementById(elementId);
        el.textContent = "";
        let i = 0;
        const interval = setInterval(() => {
            if (i < text.length) {
                el.textContent += text.charAt(i);
                i++;
            } else {
                clearInterval(interval);
            }
        }, speed);
    }

    function submitTo(actionUrl) {
        const form = document.getElementById("diagnoseForm");
        document.getElementById("loadingMessage").style.display = "block";
        typeLoadingMessage("ğŸ”„ ì§„ë‹¨ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”", "typingText", 80);
        const buttons = form.querySelectorAll("button");
        buttons.forEach(btn => btn.disabled = true);
        form.action = actionUrl;
        form.submit();
    }

    function showConsole(button) {
        const port = button.getAttribute("data-port");
        const modal = document.getElementById("consoleModal-" + port);
        if (modal) modal.style.display = "block";
    }

    function hideConsole(port) {
        const modal = document.getElementById("consoleModal-" + port);
        if (modal) modal.style.display = "none";
    }
    function openNetworkSettings() {
        try {
            // ë°ìŠ¤í¬íƒ‘ ì•±ì—ì„œ ì´ í•¨ìˆ˜ë¥¼ nativeë¡œ êµ¬í˜„í•˜ë©´ ì‹¤ì œ ì‹¤í–‰ë¨
            window.external.OpenNetworkSettings();
        } catch (e) {
            alert("ğŸ’» ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ ì—´ë ¤ë©´:\nì œì–´íŒ > ë„¤íŠ¸ì›Œí¬ ë° ê³µìœ  ì„¼í„° > ì–´ëŒ‘í„° ì„¤ì • ë³€ê²½ ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.");
        }
    }

    function openFirewallSettings() {
        try {
            window.external.OpenFirewallSettings();
        } catch (e) {
            alert("ğŸ” ë°©í™”ë²½ ì„¤ì •ì„ ì—´ë ¤ë©´:\nì œì–´íŒ > Windows Defender ë°©í™”ë²½ ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.");
        }
    }
</script>
<script>
    function callNetworkSettings() {
        fetch("/open-network-settings", { method: "POST" })
            .then(() => alert("ğŸ’» ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì°½ì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤."))
            .catch(() => alert("âš ï¸ ì„¤ì • ì°½ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
    }

    function callPortSettings() {
        fetch("/open-port-settings", { method: "POST" })
            .then(() => alert("ğŸ” ë°©í™”ë²½ ì„¤ì • ì°½ì„ ì‹¤í–‰í–ˆìŠµë‹ˆë‹¤."))
            .catch(() => alert("âš ï¸ ì„¤ì • ì°½ ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));
    }
</script>